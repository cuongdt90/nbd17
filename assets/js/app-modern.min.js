/* nbdesignerjs
 * @author  netbaseteam
 * @link https://cmsmart.net
 * @version 1.9.0
 * @created Jun 2016
 * @modified 23, MAy 2018
 * */
var nbdApp = angular.module('nbd-app', ["angularSpectrumColorpicker"]);
nbdApp.controller('designCtrl', ['$scope', 'FabricWindow',function($scope, FabricWindow){
    $scope.stages = [
        {
            config: {
                width: 410,
                height: 410
            },
            states: {},
            canvas: {}
        },       
        {
            config: {
                width: 410,
                height: 410
            },
            states: {},
            canvas: {}
        }      
    ];
    $scope.defaultStageStates = {
        isActiveLayer: false,
        isLayer: false,
        isGroup: false,
    };
    $scope.colorBackground = '#169ddf';
    $scope.changeBackgroundColor = function(color){
        console.log(color);
    };
    $scope.initSettings = function(){
        angular.copy(NBDESIGNCONFIG, $scope.settings);
        $scope.__colorPalette = __colorPalette;
    };
    $scope.settings = {};
    $scope.isModern = true;
    $scope.init = function() {
        $scope.initSettings();
        $scope.calcViewport();
    };
    $scope.$on('nbd:keypress', function(event, e){
        $scope.keypressHandle(e);
    });
    $scope.keypressHandle = function(e){
        if((e.ctrlKey || e.metaKey)) {
            e.preventDefault();
            console.log(e.which);
            
        }
    };  
    $scope.onClickStage = function( $event ){
        if(angular.element($event.target).hasClass('stage')){
            //detactive layer
        }
    };    
    $scope.$on('nbd:contextmenu', function(event, e){
        $scope.contextMenu(e);
    });
    $scope.ctxMenuStyle = {
        'top': '17%',
        'left': '33%',
        'display': 'none'
    };
    $scope.contextMenu = function(e){
        e.preventDefault();
        var posX = e.pageX,
            posY = e.pageY;
        $scope.ctxMenuStyle.top = posY;
        $scope.ctxMenuStyle.left = posX;
        $scope.ctxMenuStyle.display = 'block';
        if ($scope.$root.$$phase !== "$apply" && $scope.$root.$$phase !== "$digest") $scope.$apply()
    }; 
    $scope.$on('canvas:created', function(event, id){
        $scope.initStageSetting( id );
        var _canvas = $scope.stages[id].canvas;
        _canvas.on('mouse:down', function(options) {
            $scope.onMouseDown(id, options);
        });
        _canvas.on("mouse:over", function(options){
            $scope.onMouseOverStage(id, options);
        });
        _canvas.on("mouse:out", function(options){
            $scope.onMouseOutStage(id, options);
        });
        _canvas.on("mouse:move", function(options){
            $scope.mouseMoveStage(id, options);
        });        
        _canvas.on("mouse:up", function(options){
            $scope.onMouseUpStage(id, options);
        });
        _canvas.on("path:created", function(options){
            $scope.onPathCreated(id, options);
        });
        _canvas.on("object:added", function(options){
            $scope.onObjectAdded(id, options);
        });
        _canvas.on("object:selected", function(options){
            $scope.onObjectSelected(id, options);
        });
        _canvas.on("object:scaling", function(options){
            $scope.onObjectScaling(id, options);
        });
        _canvas.on("object:moving", function(options){
            $scope.onObjectMoving(id, options);
        });
        _canvas.on("object:rotating", function(options){
            $scope.omObjectRotating(id, options);
        });
        _canvas.on("object:modified", function(options){
            $scope.onObjectModified(id, options);
        });
        _canvas.on("before:render", function(options){
            $scope.onBeforeRender(id, options);
        });
        _canvas.on("after:render", function(options){
            $scope.onAfterRender(id, options);
        });
        _canvas.on("selection:cleared", function(options){
            $scope.onSelectionCleared(id, options);
        });
        _canvas.on("text:editing:entered", function(options){
            $scope.onEditingEntered(id, options);
        });     
        _canvas.on("text:selection:changed", function(options){
            $scope.onSelectionChanged(id, options);
        });
        
    });  
    $scope.calcViewport = function(){
        //console.log(jQuery('.nbd-stages').width() +'--'+ jQuery('.nbd-stages').height());
    };
    $scope.initStageSetting = function( id ){
        var _canvas = $scope.stages[id]['canvas'];
        $scope.setStageDimension(id);
        _canvas.controlsAboveOverlay = true;
        _canvas.calcOffset().renderAll();
    };
    $scope.addStage = function(){
        $scope.stages.push({canvas: {}});
    }; 
    $scope.setStageDimension = function(id){
        var currentWidth = $scope.stages[id].config.width,
            currentHeight = $scope.stages[id].config.width;
        $scope.stages[id]['canvas'].setDimensions({'width' : currentWidth, 'height' : currentHeight});
    };     
    $scope.switchStage = function(id, command){
        var idCurrentStage = 'stage-container-' + id,
            next =  parseInt(id) + 1;   
        if(command == 'prev')  {
            next  = parseInt(id) - 1;
        }
        if($scope.isModern){
            var idNextStage = 'stage-container-' + next;
            var currentStage = angular.element(document.getElementById(idCurrentStage)),
                nextStage = angular.element(document.getElementById(idNextStage));
            currentStage.addClass('animated');    
            currentStage.removeClass('fadeInUp');
            currentStage.removeClass('fadeInDown');  
            nextStage.addClass('animated');
            nextStage.removeClass('hidden');            
            nextStage.removeClass('fadeOutDown');            
            nextStage.removeClass('fadeOutUp');            
            if(command == 'prev'){
                currentStage.removeClass('fadeOutDown');
                currentStage.addClass('fadeOutUp');    
                nextStage.addClass('fadeInDown');                 
            }else {
                currentStage.removeClass('fadeOutUp');
                currentStage.addClass('fadeOutDown');    
                nextStage.addClass('fadeInUp');                 
            }; 
        }
        $scope.currentStage = next;
    };
    $scope.onMouseDown = function(id, options){
        console.log(id);
    };
    $scope.onMouseOverStage = function(id, options){
        
    };   
    $scope.onMouseOutStage = function(id, options){
        
    }; 
    $scope.mouseMoveStage = function(id, options){
        
    };   
    $scope.onMouseUpStage = function(id, options){
        
    };  
    $scope.onPathCreated = function(id, options){
        
    };   
    $scope.onObjectAdded = function(id, options){
        
    }; 
    $scope.onObjectSelected = function(id, options){
        
    };   
    $scope.onObjectScaling = function(id, options){
        
    };    
    $scope.onObjectMoving = function(id, options){
        
    };   
    $scope.omObjectRotating = function(id, options){
        
    };    
    $scope.onObjectModified = function(id, options){
        
    };    
    $scope.onBeforeRender = function(id, options){
        
    };      
    $scope.onAfterRender = function(id, options){
        
    };    
    $scope.onSelectionCleared = function(id, options){
        
    };     
    $scope.onEditingEntered = function(id, options){
        
    };    
    $scope.onSelectionChanged = function(id, options){
        
    };     
    $scope.onObjectSelected = function(id, options){
        var object = options.target;
        if (object.type === "text") {
            console.log(object.get('text'));
        }
    };  
    /* History */
    $scope.isRedoable = false;
    $scope.isUndoable = false;    
    
    /* Design tools */
    $scope.currentStage = 0;
    $scope.defaultText = 'Text';
    $scope.debug = function(){
        //$scope.currentStage = Math.floor(Math.random() * $scope.stages.length);
        $scope.addText();
        //$scope.ctxMenuStyle.display = 'block';
        //console.log($scope.ctxMenuStyle);
    };
    $scope.addText = function(){
        $scope.stages[$scope.currentStage]['canvas'].add(new FabricWindow.Text($scope.defaultText, {
            left: 100,
            top: 200,
            fontFamily: "Arial",
            radius: 50,
            fontSize: 30,
            textAlign: "center",
            noScaleCache: false,
            spacing: 0
        }));
    };
    
    $scope.init();
}]);
nbdApp.factory('FabricWindow', ['$window', function($window) {
    /* Fabric configuration */
    $window.fabric.Object.prototype.set({ 
        centeredScaling: true,
        transparentCorners: false,
        borderColor: 'rgba(79, 84, 103,0.7)',
        cornerStyle: 'circle',
        cornerColor: 'rgba(63, 70, 82,1)',
        borderDashArray:[2,2],
        cornerStrokeColor: 'rgba(255,255,255,1)',
        cornerSize: 15,
        fill : '#666',
        selection: false,
        borderOpacityWhenMoving: 0.6
    });
    $window.fabric.IText.prototype.set({
        cursorWidth: 1,
        cursorColor: '#000',
        cursorDuration: 500
    });
    $window.fabric.Canvas.prototype.set({
        preserveObjectStacking : true,
        selectionColor: 'rgba(100, 100, 255, 0.5)'
    });        
    return $window.fabric;
}]);
nbdApp.directive('nbdCanvas', ['FabricWindow', '$timeout', '$rootScope', function(FabricWindow, $timeout, $rootScope){
    return {
        restrict: "AE",
        scope: {
            stage: '=stage',
            index: '@'
        },
        link: function( scope, element, attrs ) {
            $timeout(function() {
                scope.stage.canvas = new FabricWindow.Canvas('nbd-stage-'+scope.index);
                scope.$emit('canvas:created', scope.index);
                element.parent().children().on("contextmenu", function(e){
                    e.preventDefault();
                    scope.$emit('nbd:contextmenu', e);
                });
            });          
        }
    }
}]);
nbdApp.directive('keypress', ['$window', function($window){
    return {
        restrict: "AE",
        link: function( scope, element, attrs ) {
            $window.document.addEventListener("keydown", function(e){
                scope.$emit('nbd:keypress', e);
            }, false);           
        }
    }
}]);
nbdApp.filter('keyboardShortcut', function($window) {
    return function(str) {
        if (!str)
            return;
        var keys = str.split('-');
        var isOSX = /Mac OS X/.test($window.navigator.userAgent);
        var seperator = (!isOSX || keys.length > 2) ? '+' : '';
        var abbreviations = {
            M: isOSX ? '⌘' : 'Ctrl',
            A: isOSX ? 'Option' : 'Alt',
            S: 'Shift'
        };
        return keys.map(function (key, index) {
            var last = index == keys.length - 1;
            return last ? key : abbreviations[key];
        }).join(seperator);
    };    
});
nbdApp.factory('NBDDataFactory', function($http){
    return {
        get : function(data, callback) {
            $http({
                method: "POST",
                url: NBDESIGNCONFIG['ajax_url'],
                params: {
                    action: "nbd_get_data",
                    nonce: NBDESIGNCONFIG['nonce_get'],
                    data: data
                }
            }).then(function(success){
                callback(success.data);
            }, function(error){
                alert('Please try again later!');
            })            
        }
    }
});